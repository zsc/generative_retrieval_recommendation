<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬6ç« ï¼šè§£ç ç­–ç•¥ä¸æ¨ç†ä¼˜åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç”Ÿæˆå¼æ£€ç´¢ä¸æ¨èç³»ç»Ÿæ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šä»ä¼ ç»Ÿæ£€ç´¢åˆ°ç”Ÿæˆå¼æ£€ç´¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šé¢„å¤‡çŸ¥è¯†é€Ÿè§ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå·®å¼‚åŒ–æœç´¢ç´¢å¼•ï¼ˆDSIï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šæ–‡æ¡£è¡¨ç¤ºä¸æ ‡è¯†ç¬¦ç”Ÿæˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šç”Ÿæˆå¼æ£€ç´¢çš„è®­ç»ƒç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šè§£ç ç­–ç•¥ä¸æ¨ç†ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šNCIä¸å¯æ‰©å±•æ€§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šGENREä¸å®ä½“æ£€ç´¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¤šæ¨¡æ€ç”Ÿæˆå¼æ£€ç´¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šç”Ÿæˆå¼æ¨èåŸºç¡€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šåºåˆ—æ¨èä¸ç”Ÿæˆæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¯¹è¯å¼æ¨èç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå¤§è¯­è¨€æ¨¡å‹æ—¶ä»£çš„ç”Ÿæˆå¼æ£€ç´¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šæ•ˆç‡ä¼˜åŒ–ä¸ç³»ç»Ÿè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè¯„ä¼°æŒ‡æ ‡ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœªæ¥æ–¹å‘ä¸å¼€æ”¾é—®é¢˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="6">ç¬¬6ç« ï¼šè§£ç ç­–ç•¥ä¸æ¨ç†ä¼˜åŒ–</h1>
<p>ç”Ÿæˆå¼æ£€ç´¢å°†æ–‡æ¡£æ£€ç´¢é—®é¢˜è½¬åŒ–ä¸ºåºåˆ—ç”Ÿæˆä»»åŠ¡ï¼Œè¿™ä½¿å¾—è§£ç ç­–ç•¥çš„é€‰æ‹©å˜å¾—è‡³å…³é‡è¦ã€‚ä¸ä¼ ç»Ÿæ£€ç´¢æ–¹æ³•çš„ç®€å•æ’åºä¸åŒï¼Œç”Ÿæˆå¼æ–¹æ³•éœ€è¦åœ¨åºå¤§çš„æ–‡æ¡£IDç©ºé—´ä¸­è¿›è¡Œé«˜æ•ˆä¸”å‡†ç¡®çš„åºåˆ—ç”Ÿæˆã€‚æœ¬ç« æ·±å…¥æ¢è®¨å„ç§è§£ç ç­–ç•¥ï¼Œä»çº¦æŸè§£ç åˆ°é«˜çº§çš„éè‡ªå›å½’æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•åœ¨ä¿æŒæ£€ç´¢è´¨é‡çš„åŒæ—¶ä¼˜åŒ–æ¨ç†æ•ˆç‡ã€‚æˆ‘ä»¬å°†ç‰¹åˆ«å…³æ³¨å®é™…éƒ¨ç½²ä¸­çš„æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬å»¶è¿Ÿã€ååé‡å’Œå†…å­˜å ç”¨çš„æƒè¡¡ã€‚</p>
<h2 id="constrained-decoding">çº¦æŸè§£ç ï¼ˆConstrained Decodingï¼‰</h2>
<p>åœ¨ç”Ÿæˆå¼æ£€ç´¢ä¸­ï¼Œæ¨¡å‹éœ€è¦ç”Ÿæˆæœ‰æ•ˆçš„æ–‡æ¡£æ ‡è¯†ç¬¦åºåˆ—ã€‚ä¸å¼€æ”¾åŸŸæ–‡æœ¬ç”Ÿæˆä¸åŒï¼Œæ–‡æ¡£IDå¿…é¡»å¯¹åº”äºå®é™…å­˜åœ¨çš„æ–‡æ¡£ï¼Œè¿™å°±éœ€è¦çº¦æŸè§£ç æœºåˆ¶æ¥ç¡®ä¿ç”Ÿæˆçš„æœ‰æ•ˆæ€§ã€‚</p>
<h3 id="_1">ç¡¬çº¦æŸä¸è½¯çº¦æŸ</h3>
<p>çº¦æŸè§£ç å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šç¡¬çº¦æŸå’Œè½¯çº¦æŸã€‚</p>
<p><strong>ç¡¬çº¦æŸ</strong>ç¡®ä¿ç”Ÿæˆçš„æ¯ä¸ªtokenéƒ½æ¥è‡ªæœ‰æ•ˆçš„è¯æ±‡è¡¨å­é›†ã€‚åœ¨ç”Ÿæˆå¼æ£€ç´¢ä¸­ï¼Œè¿™æ„å‘³ç€ï¼š</p>
<div class="codehilite"><pre><span></span><code>Valid_tokens(prefix) = {t | prefix + t âˆˆ Prefix(DocIDs)}
</code></pre></div>

<p>å…¶ä¸­<code>Prefix(DocIDs)</code>è¡¨ç¤ºæ‰€æœ‰æœ‰æ•ˆæ–‡æ¡£IDçš„å‰ç¼€é›†åˆã€‚ç¡¬çº¦æŸçš„å®ç°é€šå¸¸é‡‡ç”¨æ©ç æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">START</span><span class="o">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nl">å¯é€‰</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="err">}</span>
<span class="w">        </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">START, 2</span><span class="o">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nl">å¯é€‰</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="err">}</span><span class="w">  </span>
<span class="w">        </span><span class="n">Step</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">START, 2, 3</span><span class="o">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nl">å¯é€‰</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="err">}</span>

<span class="w">        </span><span class="nl">è¯æ±‡è¡¨æ©ç ç¤ºä¾‹</span><span class="p">:</span>
<span class="w">        </span><span class="o">[</span><span class="n">1, 1, 1, 1, 1, 0, 0, ...</span><span class="o">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="o">[</span><span class="n">1, 1, 0, 1, 0, 0, 0, 1, 0, 1, ...</span><span class="o">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span>
</code></pre></div>

<p><strong>è½¯çº¦æŸ</strong>åˆ™é€šè¿‡è°ƒæ•´æ¦‚ç‡åˆ†å¸ƒæ¥å¼•å¯¼ç”Ÿæˆï¼Œè€Œä¸å®Œå…¨ç¦æ­¢æŸäº›tokenï¼š</p>
<p>$$p'(t|prefix) = \frac{p(t|prefix) \cdot \mathbb{1}[t \in Valid(prefix)]^\alpha}{\sum_{t'} p(t'|prefix) \cdot \mathbb{1}[t' \in Valid(prefix)]^\alpha}$$
å…¶ä¸­$\alpha$æ§åˆ¶çº¦æŸçš„å¼ºåº¦ï¼Œ$\alpha \to \infty$æ—¶é€€åŒ–ä¸ºç¡¬çº¦æŸã€‚</p>
<h3 id="trie-based">Trie-basedçº¦æŸå®ç°</h3>
<p>Trieï¼ˆå‰ç¼€æ ‘ï¼‰æ˜¯å®ç°çº¦æŸè§£ç çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå‰ç¼€ï¼Œå¶èŠ‚ç‚¹å¯¹åº”å®Œæ•´çš„æ–‡æ¡£IDï¼š</p>
<div class="codehilite"><pre><span></span><code>                    root
                   /  |  \
                  1   2   3
                 /|   |\   \
                0 2   0 3   4
               /  |   |  \   \
              5   3   1   7   5

    å¯¹åº”æ–‡æ¡£IDs: {105, 123, 201, 237, 345}
</code></pre></div>

<p>Trieçš„å…³é”®æ“ä½œåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>å‰ç¼€éªŒè¯</strong>ï¼šO(k)æ—¶é—´å¤æ‚åº¦ï¼Œkä¸ºå½“å‰å‰ç¼€é•¿åº¦</li>
<li><strong>æœ‰æ•ˆåç»§è·å–</strong>ï¼šO(|Î£|)ï¼ŒÎ£ä¸ºè¯æ±‡è¡¨å¤§å°</li>
<li><strong>åŠ¨æ€æ›´æ–°</strong>ï¼šæ”¯æŒå¢é‡æ·»åŠ æ–°æ–‡æ¡£ID</li>
</ol>
<h3 id="id">æ–‡æ¡£IDç©ºé—´çš„ç‰¹æ®Šçº¦æŸ</h3>
<p>ç”Ÿæˆå¼æ£€ç´¢çš„æ–‡æ¡£IDè®¾è®¡ç›´æ¥å½±å“çº¦æŸè§£ç çš„æ•ˆç‡ã€‚ä¸åŒçš„IDè®¾è®¡ç­–ç•¥å¸¦æ¥ä¸åŒçš„çº¦æŸç‰¹æ€§å’Œè®¡ç®—å¤æ‚åº¦ã€‚</p>
<p><strong>å±‚æ¬¡åŒ–ID</strong>ï¼šå¦‚<code>[ç±»åˆ«][å­ç±»][æ–‡æ¡£å·]</code>çš„ç»“æ„å…è®¸é€å±‚çº¦æŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ç±»åˆ«é˜¶æ®µ</span><span class="o">:</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">c</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">softmax</span><span class="o">(</span><span class="n">W_c</span><span class="w"> </span><span class="err">Â·</span><span class="w"> </span><span class="n">h_0</span><span class="o">)</span>
<span class="err">å­ç±»é˜¶æ®µ</span><span class="o">:</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">s</span><span class="o">|</span><span class="n">c</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">softmax</span><span class="o">(</span><span class="n">W_s</span><span class="o">^</span><span class="n">c</span><span class="w"> </span><span class="err">Â·</span><span class="w"> </span><span class="n">h_1</span><span class="o">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="err">æ¡ä»¶å‚æ•°</span>
<span class="err">æ–‡æ¡£é˜¶æ®µ</span><span class="o">:</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">d</span><span class="o">|</span><span class="n">c</span><span class="o">,</span><span class="n">s</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">softmax</span><span class="o">(</span><span class="n">W_d</span><span class="o">^{</span><span class="n">c</span><span class="o">,</span><span class="n">s</span><span class="o">}</span><span class="w"> </span><span class="err">Â·</span><span class="w"> </span><span class="n">h_2</span><span class="o">)</span>
</code></pre></div>

<p>å±‚æ¬¡åŒ–è®¾è®¡çš„ä¼˜åŠ¿åœ¨äºæ¯ä¸€å±‚çš„å†³ç­–ç©ºé—´ç›¸å¯¹è¾ƒå°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰1000ä¸ªç±»åˆ«ã€æ¯ç±»100ä¸ªå­ç±»ã€æ¯å­ç±»1000ä¸ªæ–‡æ¡£ï¼Œåˆ™æ¯æ­¥åªéœ€ä»æœ€å¤š1000ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ï¼Œè€Œéä»1äº¿ä¸ªæ–‡æ¡£ä¸­ç›´æ¥é€‰æ‹©ã€‚è¿™ç§åˆ†è§£æå¤§é™ä½äº†è®¡ç®—å¤æ‚åº¦ï¼š
$$\text{Complexity}_{hierarchical} = O(C + S + D) \ll O(C \times S \times D) = \text{Complexity}_{flat}$$
<strong>è¯­ä¹‰èšç±»ID</strong>ï¼šç›¸ä¼¼æ–‡æ¡£å…±äº«å‰ç¼€ï¼Œå¯åˆ©ç”¨è¯­ä¹‰ä¿¡æ¯è¿›è¡Œè½¯çº¦æŸï¼š</p>
<div class="codehilite"><pre><span></span><code>Similarity_boost(t, query) = exp(cos(embed(t), embed(query)) / Ï„)
p&#39;(t|prefix, query) âˆ p(t|prefix) Â· Similarity_boost(t, query)
</code></pre></div>

<p>è¯­ä¹‰èšç±»çš„å…³é”®åœ¨äºæ„å»ºé«˜è´¨é‡çš„èšç±»æ ‘ã€‚å¸¸ç”¨æ–¹æ³•åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>K-meanså±‚æ¬¡èšç±»</strong>ï¼šé€’å½’åº”ç”¨K-meansï¼Œæ¯å±‚åˆ’åˆ†kä¸ªç°‡</li>
<li><strong>å­¦ä¹ ç´¢å¼•(Learned Index)</strong>ï¼šç«¯åˆ°ç«¯å­¦ä¹ æœ€ä¼˜åˆ’åˆ†è¾¹ç•Œ</li>
<li><strong>å¹³è¡¡æ ‘æ„å»º</strong>ï¼šç¡®ä¿æ¯ä¸ªå¶èŠ‚ç‚¹åŒ…å«ç›¸è¿‘æ•°é‡çš„æ–‡æ¡£ï¼Œé¿å…çƒ­ç‚¹</li>
</ul>
<p><strong>æ•°å€¼IDçš„ç‰¹æ®Šå¤„ç†</strong>ï¼š
å½“ä½¿ç”¨æ•°å€¼IDï¼ˆå¦‚0-999999ï¼‰æ—¶ï¼Œå¯ä»¥åˆ©ç”¨æ•°å€¼å±æ€§è¿›è¡Œé«˜æ•ˆçº¦æŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">numerical_constraint</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">min_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">):</span>
    <span class="c1"># åˆ©ç”¨æ•°å€¼èŒƒå›´å¿«é€Ÿå‰ªæ</span>
    <span class="n">prefix_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
    <span class="n">prefix_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å½“å‰å‰ç¼€å¯è¾¾çš„æ•°å€¼èŒƒå›´</span>
    <span class="n">min_reachable</span> <span class="o">=</span> <span class="n">prefix_val</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">prefix_len</span><span class="p">))</span>
    <span class="n">max_reachable</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">prefix_len</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">max_reachable</span> <span class="o">&lt;</span> <span class="n">min_id</span> <span class="ow">or</span> <span class="n">min_reachable</span> <span class="o">&gt;</span> <span class="n">max_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># è¯¥å‰ç¼€æ— æ³•åˆ°è¾¾æœ‰æ•ˆID</span>

    <span class="c1"># è¿”å›æœ‰æ•ˆçš„ä¸‹ä¸€ä½æ•°å­—</span>
    <span class="n">valid_digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">digit</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">is_valid_prefix</span><span class="p">(</span><span class="n">new_prefix</span><span class="p">,</span> <span class="n">min_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">):</span>
            <span class="n">valid_digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_digits</span>
</code></pre></div>

<h2 id="beam-search">Beam Searchå˜ä½“</h2>
<p>Beam Searchæ˜¯ç”Ÿæˆå¼æ£€ç´¢ä¸­æœ€å¸¸ç”¨çš„è§£ç ç®—æ³•ï¼Œä½†æ ‡å‡†ç‰ˆæœ¬å¹¶ä¸å®Œå…¨é€‚åˆæ£€ç´¢ä»»åŠ¡çš„ç‰¹æ®Šéœ€æ±‚ã€‚æœ¬èŠ‚æ¢è®¨é’ˆå¯¹æ£€ç´¢ä¼˜åŒ–çš„å„ç§å˜ä½“ã€‚</p>
<h3 id="beam-search_1">æ ‡å‡†Beam Searchå›é¡¾</h3>
<p>æ ‡å‡†Beam Searchç»´æŠ¤å›ºå®šå¤§å°kçš„å€™é€‰åºåˆ—é›†åˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">åˆå§‹åŒ–</span><span class="p">:</span><span class="w"> </span><span class="n">beams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">{seq: [START</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="nl">score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="err">}]</span>

<span class="k">For</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1.</span><span class="p">.</span><span class="nl">max_length</span><span class="p">:</span>
<span class="w">    </span><span class="n">candidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="w">    </span><span class="k">For</span><span class="w"> </span><span class="n">beam</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">beams</span><span class="p">:</span>
<span class="w">        </span><span class="k">For</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">vocabulary</span><span class="p">:</span>
<span class="w">            </span><span class="n">new_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beam</span><span class="p">.</span><span class="n">seq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">token</span><span class="o">]</span>
<span class="w">            </span><span class="n">new_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beam</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">token</span><span class="o">|</span><span class="n">beam</span><span class="p">.</span><span class="n">seq</span><span class="p">))</span>
<span class="w">            </span><span class="n">candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">{</span><span class="nl">seq</span><span class="p">:</span><span class="w"> </span><span class="n">new_seq</span><span class="p">,</span><span class="w"> </span><span class="nl">score</span><span class="p">:</span><span class="w"> </span><span class="n">new_score</span><span class="err">}</span><span class="p">)</span>
<span class="w">    </span><span class="n">beams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_k</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
</code></pre></div>

<p>åœ¨æ£€ç´¢åœºæ™¯ä¸­ï¼Œæ ‡å‡†Beam Searchå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li><strong>æ—©åœé—®é¢˜</strong>ï¼šä¸åŒæ–‡æ¡£IDé•¿åº¦ä¸ä¸€</li>
<li><strong>å¤šæ ·æ€§ä¸è¶³</strong>ï¼šå€¾å‘äºç”Ÿæˆç›¸ä¼¼çš„IDåºåˆ—</li>
<li><strong>è®¡ç®—å†—ä½™</strong>ï¼šè®¸å¤šå€™é€‰åºåˆ—å…±äº«é•¿å‰ç¼€</li>
</ol>
<h3 id="diverse-beam-search">Diverse Beam Search</h3>
<p>ä¸ºå¢åŠ æ£€ç´¢ç»“æœçš„å¤šæ ·æ€§ï¼ŒDiverse Beam Searchå°†beamåˆ†ç»„ï¼Œç»„é—´æ–½åŠ å¤šæ ·æ€§æƒ©ç½šï¼š</p>
<div class="codehilite"><pre><span></span><code>Groups = Gä¸ªç»„ï¼Œæ¯ç»„k/Gä¸ªbeam
For group g in 1..G:
    diversity_penalty(seq, prev_groups) = Î» Â· max_{sâˆˆprev} sim(seq, s)
    score&#39;(seq) = score(seq) - diversity_penalty(seq, groups[1:g-1])
</code></pre></div>

<p>å¤šæ ·æ€§åº¦é‡å¯ä»¥åŸºäºï¼š</p>
<ul>
<li><strong>åºåˆ—ç¼–è¾‘è·ç¦»</strong>ï¼šLevenshteinè·ç¦»</li>
<li><strong>è¯­ä¹‰ç›¸ä¼¼åº¦</strong>ï¼šåµŒå…¥ç©ºé—´çš„ä½™å¼¦ç›¸ä¼¼åº¦</li>
<li><strong>å‰ç¼€é‡å åº¦</strong>ï¼šå…±äº«å‰ç¼€é•¿åº¦</li>
</ul>
<h3 id="length-normalized-beam-search">Length-Normalized Beam Search</h3>
<p>æ–‡æ¡£IDé•¿åº¦å·®å¼‚å¯¼è‡´çŸ­åºåˆ—åå¥½é—®é¢˜ã€‚é•¿åº¦å½’ä¸€åŒ–é€šè¿‡è°ƒæ•´è¯„åˆ†æœºåˆ¶è§£å†³ï¼š
$$score_{norm}(seq) = \frac{1}{|seq|^\alpha} \sum_{i=1}^{|seq|} \log p(t_i|t_{&lt;i})$$
å…¶ä¸­$\alpha \in [0.6, 1.0]$æ˜¯é•¿åº¦æƒ©ç½šå› å­ã€‚å®è·µä¸­ï¼Œå¯ä»¥æ ¹æ®æ–‡æ¡£IDåˆ†å¸ƒåŠ¨æ€è°ƒæ•´ï¼š</p>
<div class="codehilite"><pre><span></span><code>Î±(length) = Î±_base + Î² Â· (length - avg_length) / std_length
</code></pre></div>

<h3 id="adaptive-beam-size">Adaptive Beam Size</h3>
<p>å›ºå®šbeam sizeåœ¨ä¸åŒæŸ¥è¯¢éš¾åº¦ä¸‹æ•ˆç‡ä¸ä¸€ã€‚è‡ªé€‚åº”ç­–ç•¥æ ¹æ®ç½®ä¿¡åº¦åŠ¨æ€è°ƒæ•´ï¼Œè¿™ç§åŠ¨æ€è°ƒæ•´ä¸ä»…è€ƒè™‘å½“å‰æ­¥çš„ä¸ç¡®å®šæ€§ï¼Œè¿˜è¦è€ƒè™‘å†å²ä¿¡æ¯å’Œå…¨å±€çº¦æŸã€‚</p>
<div class="codehilite"><pre><span></span><code>ç½®ä¿¡åº¦åº¦é‡:

<span class="k">-</span> ç†µ: H(p) = -Î£ p(t) log p(t)
<span class="k">-</span> Top-kæ¦‚ç‡å’Œ: Î£_{i=1}^k p_i
<span class="k">-</span> æ¦‚ç‡æ¯”: p_1 / p_2
<span class="k">-</span> é¢„æµ‹æ–¹å·®: Var(p) = Î£ p_i(1-p_i)

åŠ¨æ€è°ƒæ•´è§„åˆ™:
if H(p) &lt; threshold_low:
    beam_size = max(2, beam_size // 2)
elif H(p) &gt; threshold_high:
    beam_size = min(max_beam, beam_size * 2)
</code></pre></div>

<p><strong>å¤šç»´åº¦è‡ªé€‚åº”ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>æŸ¥è¯¢å¤æ‚åº¦è‡ªé€‚åº”</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_query_complexity</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
        <span class="s1">&#39;rare_terms&#39;</span><span class="p">:</span> <span class="n">count_rare_terms</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
        <span class="s1">&#39;ambiguity&#39;</span><span class="p">:</span> <span class="n">compute_semantic_ambiguity</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
        <span class="s1">&#39;domain_specificity&#39;</span><span class="p">:</span> <span class="n">get_domain_score</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>

<span class="n">beam_size</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">complexity_factor</span> <span class="o">*</span> <span class="n">query_complexity</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>æ·±åº¦è‡ªé€‚åº”</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">depth_adaptive_beam</span><span class="p">(</span><span class="n">current_depth</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">):</span>
    <span class="c1"># è¶Šæ·±å…¥è§£ç æ ‘ï¼Œbeam sizeè¶Šå°</span>
    <span class="n">decay_factor</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">**</span> <span class="p">(</span><span class="n">current_depth</span> <span class="o">/</span> <span class="n">max_depth</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_beam_size</span> <span class="o">*</span> <span class="n">decay_factor</span><span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>æ€§èƒ½è‡ªé€‚åº”</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PerformanceAdaptiveBeam</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_latency</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_latency</span> <span class="o">=</span> <span class="n">target_latency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adjust_beam_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_size</span><span class="p">,</span> <span class="n">last_latency</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_latency</span><span class="p">)</span>
        <span class="n">avg_latency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">avg_latency</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_latency</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_size</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">avg_latency</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_latency</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_size</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">current_size</span>
</code></pre></div>

<p>å®éªŒè¡¨æ˜ï¼Œè‡ªé€‚åº”beam sizeå¯ä»¥åœ¨ä¿æŒæ£€ç´¢è´¨é‡çš„åŒæ—¶å‡å°‘30-50%çš„è®¡ç®—é‡ã€‚åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œä¸åŒç±»å‹æŸ¥è¯¢çš„beam sizeåˆ†å¸ƒå‘ˆç°æ˜æ˜¾æ¨¡å¼ï¼š</p>
<ul>
<li>å¯¼èˆªå‹æŸ¥è¯¢ï¼ˆæ˜ç¡®ç›®æ ‡ï¼‰ï¼šå¹³å‡beam size 3-5</li>
<li>ä¿¡æ¯å‹æŸ¥è¯¢ï¼ˆæ¢ç´¢æ€§ï¼‰ï¼šå¹³å‡beam size 8-15</li>
<li>äº‹åŠ¡å‹æŸ¥è¯¢ï¼ˆå¤šæ­¥éª¤ï¼‰ï¼šå¹³å‡beam size 10-20</li>
</ul>
<h2 id="_2">å‰ç¼€æ ‘åŠ é€Ÿ</h2>
<p>å‰ç¼€æ ‘ï¼ˆTrieï¼‰ä¸ä»…ç”¨äºçº¦æŸè§£ç ï¼Œè¿˜æ˜¯åŠ é€Ÿç”Ÿæˆå¼æ£€ç´¢çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚æœ¬èŠ‚æ·±å…¥æ¢è®¨å¦‚ä½•åˆ©ç”¨Trieä¼˜åŒ–æ¨ç†æ•ˆç‡ã€‚</p>
<h3 id="trie">Trieæ•°æ®ç»“æ„çš„æ£€ç´¢ä¼˜åŒ–</h3>
<p>æ ‡å‡†Trieå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¼˜åŒ–æå‡æ£€ç´¢æ€§èƒ½ï¼š</p>
<p><strong>å‹ç¼©è·¯å¾„</strong>ï¼šå•å­èŠ‚ç‚¹è·¯å¾„å‹ç¼©æˆè¾¹ï¼Œå‡å°‘éå†æ­¥éª¤ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">æ ‡å‡†</span><span class="n">Trie</span><span class="o">:</span><span class="w">           </span><span class="err">å‹ç¼©</span><span class="n">Trie</span><span class="o">:</span>
<span class="w">    </span><span class="mi">1</span><span class="w">                   </span><span class="mi">1</span>
<span class="w">    </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span>
<span class="w">    </span><span class="mi">2</span><span class="w">                  </span><span class="mi">23</span>
<span class="w">    </span><span class="o">|</span><span class="w">                  </span><span class="o">/</span><span class="w"> </span><span class="o">\</span>
<span class="w">    </span><span class="mi">3</span><span class="w">                 </span><span class="mi">4</span><span class="w">   </span><span class="mi">7</span>
<span class="w">   </span><span class="o">/</span><span class="w"> </span><span class="o">\</span>
<span class="w">  </span><span class="mi">4</span><span class="w">   </span><span class="mi">7</span>
</code></pre></div>

<p><strong>ä½å›¾ç´¢å¼•</strong>ï¼šä½¿ç”¨ä½å›¾åŠ é€Ÿå­èŠ‚ç‚¹æŸ¥æ‰¾ï¼š</p>
<div class="codehilite"><pre><span></span><code>struct TrieNode {
    uint256 child_bitmap;  // 256ä½ï¼Œæ ‡è®°å­˜åœ¨çš„å­èŠ‚ç‚¹
    Node* children[popcnt(child_bitmap)];  // åªå­˜å‚¨å®é™…å­èŠ‚ç‚¹
}

æŸ¥æ‰¾å¤æ‚åº¦: O(1) with SIMD popcnt
</code></pre></div>

<p><strong>ç¼“å­˜å‹å¥½å¸ƒå±€</strong>ï¼šå°†çƒ­ç‚¹è·¯å¾„çš„èŠ‚ç‚¹åœ¨å†…å­˜ä¸­è¿ç»­å­˜å‚¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">å†…å­˜å¸ƒå±€</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">root</span><span class="o">][</span><span class="n">é«˜é¢‘å­æ ‘1</span><span class="o">][</span><span class="n">é«˜é¢‘å­æ ‘2</span><span class="o">]</span><span class="p">...</span><span class="o">[</span><span class="n">ä½é¢‘èŠ‚ç‚¹</span><span class="o">]</span>
<span class="n">Cache</span><span class="w"> </span><span class="n">lineåˆ©ç”¨ç‡æå‡40</span><span class="o">-</span><span class="mi">60</span><span class="o">%</span>
</code></pre></div>

<h3 id="_3">åŠ¨æ€å‰ªæç­–ç•¥</h3>
<p>å®æ—¶å‰ªæå¯ä»¥å¤§å¹…å‡å°‘æœç´¢ç©ºé—´ï¼š</p>
<p><strong>æ¦‚ç‡å‰ªæ</strong>ï¼šå½“ç´¯ç§¯æ¦‚ç‡ä½äºé˜ˆå€¼æ—¶åœæ­¢æ‰©å±•ï¼š</p>
<div class="codehilite"><pre><span></span><code>prune_threshold = max_score - Î´
if current_score &lt; prune_threshold:
    åœæ­¢è¯¥åˆ†æ”¯æ¢ç´¢
</code></pre></div>

<p><strong>Top-kå‰ªæ</strong>ï¼šåªä¿ç•™æ¯å±‚æ¦‚ç‡æœ€é«˜çš„kä¸ªèŠ‚ç‚¹ï¼š</p>
<div class="codehilite"><pre><span></span><code>Layer 1: ä¿ç•™top-100èŠ‚ç‚¹
Layer 2: ä¿ç•™top-50èŠ‚ç‚¹  
Layer 3: ä¿ç•™top-20èŠ‚ç‚¹
...é€å±‚é€’å‡
</code></pre></div>

<p><strong>è‡ªé€‚åº”å‰ªæ</strong>ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´ï¼š</p>
<div class="codehilite"><pre><span></span><code>æŸ¥è¯¢é•¿åº¦ &lt; 5: aggressive_pruning
æŸ¥è¯¢é•¿åº¦ 5-10: moderate_pruning  
æŸ¥è¯¢é•¿åº¦ &gt; 10: conservative_pruning
</code></pre></div>

<h3 id="_4">æ‰¹å¤„ç†ä¸å¹¶è¡ŒåŒ–</h3>
<p>æ‰¹å¤„ç†å’Œå¹¶è¡ŒåŒ–æ˜¯æå‡ç”Ÿæˆå¼æ£€ç´¢ååé‡çš„å…³é”®æŠ€æœ¯ã€‚é€šè¿‡å……åˆ†åˆ©ç”¨ç°ä»£ç¡¬ä»¶çš„å¹¶è¡Œèƒ½åŠ›ï¼Œå¯ä»¥å®ç°æ•°é‡çº§çš„æ€§èƒ½æå‡ã€‚</p>
<p><strong>SIMDå¹¶è¡Œå‰ç¼€åŒ¹é…</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// AVX2å®ç°çš„8è·¯å¹¶è¡Œå‰ç¼€åŒ¹é…</span>
<span class="n">__m256i</span><span class="w"> </span><span class="n">query_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_docs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__m256i</span><span class="w"> </span><span class="n">doc_vecs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="o">&amp;</span><span class="n">docs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">__m256i</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_cmpeq_epi32</span><span class="p">(</span><span class="n">query_vec</span><span class="p">,</span><span class="w"> </span><span class="n">doc_vecs</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_movemask_epi8</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ‰¾åˆ°åŒ¹é…ï¼Œæå–å…·ä½“ä½ç½®</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__builtin_ctz</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="n">results</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// AVX-512è¿›ä¸€æ­¥æå‡åˆ°16è·¯å¹¶è¡Œ</span>
<span class="n">__m512i</span><span class="w"> </span><span class="n">query_vec_512</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm512_loadu_si512</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_docs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__m512i</span><span class="w"> </span><span class="n">doc_vecs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm512_loadu_si512</span><span class="p">(</span><span class="o">&amp;</span><span class="n">docs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">__mmask16</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm512_cmpeq_epi32_mask</span><span class="p">(</span><span class="n">query_vec_512</span><span class="p">,</span><span class="w"> </span><span class="n">doc_vecs</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">process_matches</span><span class="p">(</span><span class="n">match</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>GPUåŠ é€ŸTrieéå†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¼˜åŒ–çš„GPU Trieéå†ï¼Œä½¿ç”¨å…±äº«å†…å­˜ç¼“å­˜çƒ­ç‚¹èŠ‚ç‚¹</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">trie_search_optimized</span><span class="p">(</span><span class="n">TrieNode</span><span class="o">*</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                      </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_queries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="kt">__shared__</span><span class="w"> </span><span class="n">TrieNode</span><span class="w"> </span><span class="n">shared_cache</span><span class="p">[];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åä½œåŠ è½½çƒ­ç‚¹èŠ‚ç‚¹åˆ°å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CACHE_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">shared_cache</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">hot_node_indices</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_queries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queries</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">        </span><span class="n">TrieNode</span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// root</span>

<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">child_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// å…ˆæ£€æŸ¥å…±äº«å†…å­˜ç¼“å­˜</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">cache_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_in_cache</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">child_idx</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">cache_idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shared_cache</span><span class="p">[</span><span class="n">cache_idx</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// ä»å…¨å±€å†…å­˜è¯»å–</span>
<span class="w">                </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">child_idx</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">query</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">results</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">doc_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Warpçº§åˆ«çš„åä½œæœç´¢</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">warp_collaborative_search</span><span class="p">(</span><span class="n">TrieNode</span><span class="o">*</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">warp_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lane_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">query_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">warp_id</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">query_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_queries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queries</span><span class="p">[</span><span class="n">query_id</span><span class="p">];</span>
<span class="w">        </span><span class="n">TrieNode</span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// Warpå†…çº¿ç¨‹åä½œéå†ä¸åŒåˆ†æ”¯</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">num_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">num_children</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">child_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num_children</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">child_per_thread</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">child_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lane_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">child_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹æ¢ç´¢ä¸€ä¸ªå­èŠ‚ç‚¹</span>
<span class="w">                    </span><span class="n">explore_branch</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">child_idx</span><span class="p">]);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// WarpæŠ•ç¥¨é€‰æ‹©æœ€ä¼˜åˆ†æ”¯</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">best_branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warp_vote_best_branch</span><span class="p">();</span>
<span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">best_branch</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å¤šçº§å¹¶è¡Œç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiLevelParallelizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
        <span class="c1"># Level 1: æŒ‰æŸ¥è¯¢å¤æ‚åº¦åˆ†ç»„</span>
        <span class="n">simple_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">complex_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span>

        <span class="c1"># Level 2: ç®€å•æŸ¥è¯¢CPUå¹¶è¡Œï¼Œå¤æ‚æŸ¥è¯¢GPUå¤„ç†</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># CPUå¤„ç†ç®€å•æŸ¥è¯¢</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">(</span><span class="n">simple_queries</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_batch_search</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

        <span class="c1"># GPUå¤„ç†å¤æ‚æŸ¥è¯¢</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_available</span> <span class="ow">and</span> <span class="n">complex_queries</span><span class="p">:</span>
            <span class="n">gpu_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_batch_search</span><span class="p">(</span><span class="n">complex_queries</span><span class="p">)</span>

        <span class="c1"># æ”¶é›†ç»“æœ</span>
        <span class="n">cpu_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">merge_results</span><span class="p">(</span><span class="n">cpu_results</span><span class="p">,</span> <span class="n">gpu_results</span><span class="p">)</span>
</code></pre></div>

<h3 id="_5">å†…å­˜ä¸é€Ÿåº¦æƒè¡¡</h3>
<p>ä¸åŒçš„Trieå˜ä½“åœ¨å†…å­˜å’Œé€Ÿåº¦é—´æœ‰ä¸åŒæƒè¡¡ï¼š</p>
<p>| æ•°æ®ç»“æ„ | å†…å­˜å ç”¨ | æŸ¥è¯¢é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>æ•°æ®ç»“æ„</th>
<th>å†…å­˜å ç”¨</th>
<th>æŸ¥è¯¢é€Ÿåº¦</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡å‡†Trie</td>
<td>O(NÃ—M)</td>
<td>O(M)</td>
<td>å°è§„æ¨¡ç²¾ç¡®åŒ¹é…</td>
</tr>
<tr>
<td>å‹ç¼©Trie</td>
<td>O(N)</td>
<td>O(M)</td>
<td>ä¸­ç­‰è§„æ¨¡</td>
</tr>
<tr>
<td>HAT-Trie</td>
<td>O(N/B)</td>
<td>O(MÃ—logB)</td>
<td>å¤§è§„æ¨¡ç¼“å­˜ä¼˜åŒ–</td>
</tr>
<tr>
<td>Succinct Trie</td>
<td>O(NÃ—H(Î£))</td>
<td>O(MÃ—logÎ£)</td>
<td>è¶…å¤§è§„æ¨¡</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­Næ˜¯æ–‡æ¡£æ•°ï¼ŒMæ˜¯å¹³å‡IDé•¿åº¦ï¼ŒBæ˜¯æ¡¶å¤§å°ï¼ŒÎ£æ˜¯å­—ç¬¦é›†å¤§å°ã€‚</p>
<h2 id="_6">é«˜çº§è¯é¢˜ï¼šéè‡ªå›å½’è§£ç åœ¨æ£€ç´¢ä¸­çš„åº”ç”¨</h2>
<p>ä¼ ç»Ÿçš„è‡ªå›å½’ï¼ˆARï¼‰è§£ç é€ä¸ªç”Ÿæˆtokenï¼Œæ¨ç†å»¶è¿Ÿä¸åºåˆ—é•¿åº¦æˆæ­£æ¯”ã€‚éè‡ªå›å½’ï¼ˆNARï¼‰æ¨¡å‹é€šè¿‡å¹¶è¡Œç”Ÿæˆæ‰€æœ‰tokenæ¥çªç ´è¿™ä¸€é™åˆ¶ï¼Œä¸ºç”Ÿæˆå¼æ£€ç´¢å¸¦æ¥æ˜¾è‘—çš„é€Ÿåº¦æå‡ã€‚</p>
<h3 id="nar">NARæ¨¡å‹åŸºç¡€</h3>
<p>éè‡ªå›å½’æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯æ‰“ç ´tokené—´çš„é¡ºåºä¾èµ–ï¼š</p>
<p><strong>è‡ªå›å½’ç”Ÿæˆ</strong>ï¼š
$$p_{AR}(y|x) = \prod_{t=1}^T p(y_t|y_{&lt;t}, x)$$
<strong>éè‡ªå›å½’ç”Ÿæˆ</strong>ï¼š
$$p_{NAR}(y|x) = p(T|x) \prod_{t=1}^T p(y_t|x)$$</p>
<p>å…¶ä¸­Tæ˜¯åºåˆ—é•¿åº¦ï¼Œå¯ä»¥é€šè¿‡é•¿åº¦é¢„æµ‹å™¨è·å¾—ã€‚</p>
<h3 id="_7">å¹¶è¡Œè§£ç ç­–ç•¥</h3>
<p>NARåœ¨ç”Ÿæˆå¼æ£€ç´¢ä¸­çš„å®ç°éœ€è¦ç‰¹æ®Šè®¾è®¡ï¼š</p>
<p><strong>1. é•¿åº¦é¢„æµ‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>length_logits = length_predictor(query_encoding)
predicted_lengths = top_k(softmax(length_logits), k=3)
<span class="gh">#</span> åŒæ—¶å°è¯•å¤šä¸ªé•¿åº¦ï¼Œåå¤„ç†é€‰æ‹©æœ€ä½³
</code></pre></div>

<p><strong>2. å¹¶è¡Œä½ç½®ç”Ÿæˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> æ‰€æœ‰ä½ç½®åŒæ—¶é¢„æµ‹
position_embeddings = get_position_embeddings(max_length)
decoder_input = query_encoding + position_embeddings
all_logits = decoder(decoder_input)  # [batch, max_length, vocab]
</code></pre></div>

<p><strong>3. CTCè§£ç </strong>ï¼ˆå¤„ç†é‡å¤å’Œç©ºç™½ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>åŸå§‹è¾“å‡º: [1, 1, Îµ, 2, 2, 3, Îµ, 3]
CTCåˆå¹¶: [1, 2, 3]  # Îµè¡¨ç¤ºç©ºç™½ï¼Œé‡å¤åˆå¹¶
</code></pre></div>

<h3 id="_8">è¿­ä»£ç²¾åŒ–æœºåˆ¶</h3>
<p>NARçš„ä¸€æ¬¡ç”Ÿæˆè´¨é‡é€šå¸¸ä¸å¦‚ARï¼Œè¿­ä»£ç²¾åŒ–å¯ä»¥æ”¹å–„ã€‚ç²¾åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¤šè½®è¿­ä»£é€æ­¥æé«˜ç”Ÿæˆè´¨é‡ï¼Œæ¯è½®èšç„¦äºä¿®æ­£ä½ç½®ä¿¡åº¦çš„éƒ¨åˆ†ã€‚</p>
<p><strong>Mask-Predictç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Step 1: åˆå§‹å¹¶è¡Œç”Ÿæˆ y^(0)
Step 2-N: è¿­ä»£ç²¾åŒ–

    <span class="k">-</span> è®¡ç®—æ¯ä¸ªä½ç½®çš„ç½®ä¿¡åº¦: conf_t = p(y_t^(i-1)|x)
    <span class="k">-</span> Maskä½ç½®ä¿¡ä½ç½®: mask = (conf &lt; threshold)
    <span class="k">-</span> é‡æ–°é¢„æµ‹maskedä½ç½®: y^(i) = predict(y^(i-1), mask, x)
</code></pre></div>

<p>è¿™ç§ç­–ç•¥çš„å…³é”®åœ¨äºç½®ä¿¡åº¦ä¼°è®¡çš„å‡†ç¡®æ€§ã€‚å®è·µä¸­å¸¸ç”¨çš„ç½®ä¿¡åº¦åº¦é‡åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>Tokenæ¦‚ç‡</strong>ï¼šç›´æ¥ä½¿ç”¨softmaxè¾“å‡ºçš„æœ€å¤§æ¦‚ç‡</li>
<li><strong>ç†µå€¼</strong>ï¼š$H(p_t) = -\sum_v p_t(v) \log p_t(v)$</li>
<li><strong>æ¦‚ç‡å·®</strong>ï¼štop-1å’Œtop-2æ¦‚ç‡çš„å·®å€¼</li>
<li><strong>é›†æˆç½®ä¿¡åº¦</strong>ï¼šå¤šä¸ªæ¨¡å‹é¢„æµ‹çš„ä¸€è‡´æ€§</li>
</ul>
<p><strong>ç½®ä¿¡åº¦é©±åŠ¨çš„ç²¾åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">iterative_refine</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">initial_predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">refinement_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iters</span><span class="p">):</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="n">get_confidences</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">avg_conf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span>
        <span class="n">refinement_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_conf</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># è‡ªé€‚åº”é˜ˆå€¼ï¼šéšè¿­ä»£æ¬¡æ•°å¢åŠ è€Œæ”¾æ¾</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">confidences</span> <span class="o">&lt;</span> <span class="n">adaptive_threshold</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># åªç²¾åŒ–æœ€éœ€è¦æ”¹è¿›çš„ä½ç½®</span>
        <span class="n">num_to_refine</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">*</span> <span class="n">decay_rate</span> <span class="o">**</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">positions_to_refine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">confidences</span><span class="p">)[:</span><span class="n">num_to_refine</span><span class="p">]</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">positions_to_refine</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="c1"># æ—©åœæ£€æµ‹</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_conf</span> <span class="o">-</span> <span class="n">refinement_history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># ç½®ä¿¡åº¦ä¸å†æ˜¾è‘—æå‡</span>

    <span class="k">return</span> <span class="n">y</span>
</code></pre></div>

<p><strong>CMLMï¼ˆConditional Masked Language Modelï¼‰ç²¾åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CMLMRefiner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mask_ratio_schedule</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_schedule</span> <span class="o">=</span> <span class="n">mask_ratio_schedule</span>  <span class="c1"># [0.5, 0.3, 0.1]</span>

    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">initial_output</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">initial_output</span>

        <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iters</span><span class="p">):</span>
            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_schedule</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">iter_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_schedule</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

            <span class="c1"># åŸºäºç½®ä¿¡åº¦çš„è‡ªé€‚åº”masking</span>
            <span class="n">token_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_token_probabilities</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">num_mask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span>

            <span class="c1"># ä¼˜å…ˆmaskä½ç½®ä¿¡åº¦token</span>
            <span class="n">mask_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">token_probs</span><span class="p">)[:</span><span class="n">num_mask</span><span class="p">]</span>

            <span class="c1"># æ¡ä»¶ç”Ÿæˆ</span>
            <span class="n">masked_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">mask_positions</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_masked</span><span class="p">(</span><span class="n">masked_input</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

            <span class="c1"># æ›´æ–°maskedä½ç½®</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">mask_positions</span><span class="p">:</span>
                <span class="n">current</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">current</span>
</code></pre></div>

<h3 id="narar">NARä¸ARçš„æ··åˆæ¶æ„</h3>
<p>å®è·µä¸­ï¼Œæ··åˆæ¶æ„å¾€å¾€èƒ½å–å¾—æœ€ä½³æ•ˆæœã€‚å…³é”®åœ¨äºå¦‚ä½•æ™ºèƒ½åœ°ç»“åˆä¸¤ç§èŒƒå¼çš„ä¼˜åŠ¿ï¼šARçš„é«˜è´¨é‡ç”Ÿæˆå’ŒNARçš„é«˜æ•ˆæ¨ç†ã€‚</p>
<p><strong>æµ…å±‚AR + æ·±å±‚NAR</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>å‰ç¼€ç”Ÿæˆ(AR): [ç±»åˆ«][å­ç±»]  # 2-3æ­¥ï¼Œç¡®å®šå¤§æ–¹å‘
åç¼€ç”Ÿæˆ(NAR): [æ–‡æ¡£ç¼–å·]    # å¹¶è¡Œç”Ÿæˆå‰©ä½™éƒ¨åˆ†

ä¼˜åŠ¿åˆ†æï¼š

<span class="k">-</span> å‰ç¼€çš„å‡†ç¡®æ€§å¯¹æœ€ç»ˆç»“æœå½±å“å¤§ï¼Œä½¿ç”¨ARä¿è¯è´¨é‡
<span class="k">-</span> åç¼€åœ¨å‰ç¼€ç¡®å®šåé€‰æ‹©ç©ºé—´å°ï¼ŒNARè¶³å¤Ÿå‡†ç¡®
<span class="k">-</span> æ€»å»¶è¿Ÿ = AR_steps Ã— t_ar + t_nar â‰ˆ 3Ã—5ms + 10ms = 25ms
</code></pre></div>

<p><strong>ç½®ä¿¡åº¦åˆ‡æ¢</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveDecoder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ar_model</span><span class="p">,</span> <span class="n">nar_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ar_model</span> <span class="o">=</span> <span class="n">ar_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nar_model</span> <span class="o">=</span> <span class="n">nar_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complexity_estimator</span> <span class="o">=</span> <span class="n">QueryComplexityEstimator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complexity_estimator</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># å¤šç»´åº¦å†³ç­–</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;query_length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
            <span class="s1">&#39;vocabulary_entropy&#39;</span><span class="p">:</span> <span class="n">compute_vocab_entropy</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
            <span class="s1">&#39;expected_results&#39;</span><span class="p">:</span> <span class="n">estimate_result_count</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
            <span class="s1">&#39;latency_budget&#39;</span><span class="p">:</span> <span class="n">get_current_latency_budget</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_use_nar</span><span class="p">(</span><span class="n">complexity</span><span class="p">,</span> <span class="n">factors</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nar_decode_with_fallback</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ar_decode_with_early_stop</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nar_decode_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># NARç”Ÿæˆ</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nar_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nar_model</span><span class="o">.</span><span class="n">get_confidences</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># ä½ç½®ä¿¡åº¦æ—¶å›é€€åˆ°AR</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ar_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<p><strong>çº§è”æ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CascadeRetrieval</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nar_coarse</span> <span class="o">=</span> <span class="n">FastNARModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ar_fine</span> <span class="o">=</span> <span class="n">AccurateARModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reranker</span> <span class="o">=</span> <span class="n">LearnedReranker</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Stage 1: NARå¿«é€Ÿå¬å›</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">coarse_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nar_coarse</span><span class="o">.</span><span class="n">generate_batch</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> 
            <span class="n">num_candidates</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">beam_size</span><span class="o">=</span><span class="mi">5</span>  <span class="c1"># NARä½¿ç”¨å°beam</span>
        <span class="p">)</span>
        <span class="n">coarse_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>  <span class="c1"># ~10ms</span>

        <span class="c1"># Stage 2: ARç²¾ç»†é‡æ’</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">refined_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">coarse_candidates</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>  <span class="c1"># åªç²¾æ’top-20</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ar_fine</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span>
            <span class="n">refined_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">candidate</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

        <span class="n">refined_candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rerank_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t2</span>  <span class="c1"># ~20ms</span>

        <span class="c1"># Stage 3: å­¦ä¹ çš„é‡æ’å™¨ï¼ˆå¯é€‰ï¼‰</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reranker</span><span class="p">:</span>
            <span class="n">final_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reranker</span><span class="o">.</span><span class="n">rerank</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> 
                <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">refined_candidates</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">refined_candidates</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]]</span>

        <span class="n">total_time</span> <span class="o">=</span> <span class="n">coarse_time</span> <span class="o">+</span> <span class="n">rerank_time</span>
        <span class="k">return</span> <span class="n">final_results</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">}</span>
</code></pre></div>

<p><strong>åŠ¨æ€æ¶æ„é€‰æ‹©</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicArchitectureSelector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pure_ar&#39;</span><span class="p">:</span> <span class="n">PureARModel</span><span class="p">(),</span>
            <span class="s1">&#39;pure_nar&#39;</span><span class="p">:</span> <span class="n">PureNARModel</span><span class="p">(),</span>
            <span class="s1">&#39;hybrid_shallow&#39;</span><span class="p">:</span> <span class="n">ShallowARDeepNAR</span><span class="p">(),</span>
            <span class="s1">&#39;hybrid_cascade&#39;</span><span class="p">:</span> <span class="n">CascadeModel</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">select_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># åŸºäºå†å²æ€§èƒ½æ•°æ®é€‰æ‹©</span>
        <span class="n">query_features</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">predicted_performance</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># é¢„æµ‹æ¯ç§æ¶æ„çš„æ€§èƒ½</span>
            <span class="n">predicted_performance</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="n">query_features</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># å¤šç›®æ ‡ä¼˜åŒ–ï¼šå»¶è¿Ÿvså‡†ç¡®ç‡</span>
        <span class="n">best_architecture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_optimal_choice</span><span class="p">(</span>
            <span class="n">predicted_performance</span><span class="p">,</span>
            <span class="n">latency_weight</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latency_importance&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">accuracy_weight</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy_importance&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">best_architecture</span><span class="p">]</span>
</code></pre></div>

<h3 id="_9">æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–æŒ‡å—</h3>
<p>ä¸åŒè§£ç ç­–ç•¥åœ¨å„ç§ç»´åº¦ä¸Šçš„è¯¦ç»†å¯¹æ¯”ï¼š</p>
<p>| æŒ‡æ ‡ | è‡ªå›å½’(AR) | éè‡ªå›å½’(NAR) | æ··åˆæ¶æ„ |
| æ¨ç†å»¶è¿Ÿ | O(T)ï¼Œ~100ms | O(1)ï¼Œ~20ms | O(k), k&lt;&lt;Tï¼Œ~30ms |
| å‡†ç¡®ç‡@1 | 95% | 88% | 93% |
| å‡†ç¡®ç‡@10 | 98% | 94% | 97% |
| ååé‡ | 100 QPS | 500 QPS | 300 QPS |
| æ¨¡å‹å¤§å° | 1Ã— | 1.2Ã— | 1.5Ã— |
| GPUå†…å­˜å ç”¨ | åŸºå‡† | +20%ï¼ˆå¹¶è¡ŒåŒ–ï¼‰ | +30%ï¼ˆåŒæ¨¡å‹ï¼‰ |
| è®­ç»ƒå¤æ‚åº¦ | æ ‡å‡† | 2Ã—ï¼ˆéœ€è¦ç‰¹æ®ŠæŸå¤±ï¼‰ | 2.5Ã—ï¼ˆè”åˆè®­ç»ƒï¼‰ |
| éƒ¨ç½²å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ | å¤æ‚ |</p>
<p><strong>ç»†ç²’åº¦æ€§èƒ½åˆ†æ</strong>ï¼š</p>
<ol>
<li><strong>ä¸åŒæŸ¥è¯¢é•¿åº¦çš„è¡¨ç°</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>æŸ¥è¯¢é•¿åº¦  | ARå»¶è¿Ÿ | NARå»¶è¿Ÿ | æ··åˆå»¶è¿Ÿ | æœ€ä¼˜é€‰æ‹©
---------|--------|---------|----------|----------
1-3è¯    | 30ms   | 15ms    | 20ms     | NAR
4-7è¯    | 60ms   | 18ms    | 25ms     | æ··åˆ
8-15è¯   | 120ms  | 25ms    | 35ms     | æ··åˆ
&gt;15è¯    | 200ms+ | 35ms    | 50ms     | NAR(ç²¾åº¦å®¹å¿æ—¶)
</code></pre></div>

<ol start="2">
<li><strong>ä¸åŒæ–‡æ¡£é›†è§„æ¨¡çš„æ‰©å±•æ€§</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>æ–‡æ¡£æ•°é‡   | ARæ€§èƒ½   | NARæ€§èƒ½  | æ¨èæ–¹æ¡ˆ
----------|----------|----------|------------
&lt;10K      | ä¼˜ç§€     | è‰¯å¥½     | ARï¼ˆè´¨é‡ä¼˜å…ˆï¼‰
10K-100K  | è‰¯å¥½     | ä¼˜ç§€     | æ··åˆ
100K-1M   | ä¸€èˆ¬     | ä¼˜ç§€     | NAR+ç²¾æ’
&gt;1M       | å·®       | è‰¯å¥½     | åˆ†å±‚NAR
</code></pre></div>

<ol start="3">
<li><strong>ç¡¬ä»¶é…ç½®å½±å“</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">hardware_optimized_selection</span><span class="p">(</span><span class="n">hardware_profile</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">hardware_profile</span><span class="p">[</span><span class="s1">&#39;gpu_memory&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>  <span class="c1"># GB</span>
        <span class="k">return</span> <span class="s1">&#39;quantized_nar&#39;</span>  <span class="c1"># é‡åŒ–çš„NARæ¨¡å‹</span>
    <span class="k">elif</span> <span class="n">hardware_profile</span><span class="p">[</span><span class="s1">&#39;gpu_compute&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">7.0</span><span class="p">:</span>  <span class="c1"># è®¡ç®—èƒ½åŠ›</span>
        <span class="k">return</span> <span class="s1">&#39;cpu_ar_gpu_nar&#39;</span>  <span class="c1"># CPUè¿è¡ŒARï¼ŒGPUè¿è¡ŒNAR</span>
    <span class="k">elif</span> <span class="n">hardware_profile</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;pipeline_hybrid&#39;</span>  <span class="c1"># æµæ°´çº¿å¹¶è¡Œçš„æ··åˆæ¨¡å‹</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;standard_hybrid&#39;</span>
</code></pre></div>

<h2 id="_10">å·¥ä¸šæ¡ˆä¾‹ï¼šå­—èŠ‚è·³åŠ¨æŠ–éŸ³æœç´¢çš„å®æ—¶æ¨ç†ä¼˜åŒ–</h2>
<p>å­—èŠ‚è·³åŠ¨åœ¨æŠ–éŸ³æœç´¢ä¸­éƒ¨ç½²ç”Ÿæˆå¼æ£€ç´¢é¢ä¸´ç‹¬ç‰¹æŒ‘æˆ˜ï¼šäº¿çº§çŸ­è§†é¢‘åº“ã€æ¯«ç§’çº§å»¶è¿Ÿè¦æ±‚ã€æ¯ç§’æ•°ä¸‡æŸ¥è¯¢ã€‚æœ¬èŠ‚æ·±å…¥åˆ†æå…¶ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h3 id="_11">ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</h3>
<p>æŠ–éŸ³æœç´¢é‡‡ç”¨ä¸‰å±‚æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code>ç”¨æˆ·æŸ¥è¯¢
    â†“
[å¬å›å±‚] ç”Ÿæˆå¼æ£€ç´¢ + ä¼ ç»Ÿå€’æ’
    â†“ 1000å€™é€‰
[ç²—æ’å±‚] è½»é‡çº§æ‰“åˆ†
    â†“ 100å€™é€‰  
[ç²¾æ’å±‚] å¤æ‚æ¨¡å‹æ‰“åˆ†
    â†“ 10ç»“æœ
å±•ç¤ºç»™ç”¨æˆ·
</code></pre></div>

<p>ç”Ÿæˆå¼æ£€ç´¢åœ¨å¬å›å±‚æ‰¿æ‹…ä¸»è¦èŒè´£ï¼Œéœ€è¦åœ¨50mså†…è¿”å›ç»“æœã€‚</p>
<h3 id="_12">æ¨¡å‹ä¼˜åŒ–ç­–ç•¥</h3>
<p><strong>1. çŸ¥è¯†è’¸é¦</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">æ•™å¸ˆæ¨¡å‹</span><span class="o">:</span><span class="w"> </span><span class="mi">24</span><span class="err">å±‚</span><span class="n">BERT</span><span class="o">-</span><span class="n">large</span><span class="w"> </span><span class="o">(</span><span class="mi">340</span><span class="n">Må‚æ•°</span><span class="o">)</span>
<span class="err">å­¦ç”Ÿæ¨¡å‹</span><span class="o">:</span><span class="w"> </span><span class="mi">6</span><span class="err">å±‚</span><span class="n">DistilBERT</span><span class="w"> </span><span class="o">(</span><span class="mi">66</span><span class="n">Må‚æ•°</span><span class="o">)</span>

<span class="err">è’¸é¦æŸå¤±</span><span class="o">:</span>
<span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">Î±Â·</span><span class="n">L_hard</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">Î±</span><span class="o">)</span><span class="err">Â·</span><span class="n">L_soft</span>
<span class="n">L_soft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KL</span><span class="o">(</span><span class="n">student_logits</span><span class="sr">/T, teacher_logits/</span><span class="n">T</span><span class="o">)</span>
</code></pre></div>

<p><strong>2. æ··åˆç²¾åº¦æ¨ç†</strong>ï¼š
- Embeddingå±‚: FP16
- Attentionè®¡ç®—: INT8
- æœ€ç»ˆlogits: FP32
- åŠ é€Ÿæ¯”: 2.3Ã—ï¼Œå‡†ç¡®ç‡æŸå¤± &lt; 0.5%</p>
<p><strong>3. åŠ¨æ€æ‰¹å¤„ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicBatcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_batch</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">max_wait</span><span class="o">=</span><span class="mi">10</span><span class="n">ms</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_queries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_queries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_batch</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">time_since_first</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_wait</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">()</span>
</code></pre></div>

<h3 id="_13">åˆ†å¸ƒå¼éƒ¨ç½²æ–¹æ¡ˆ</h3>
<p><strong>æ¨¡å‹åˆ†ç‰‡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Model Parallel:

<span class="k">-</span> Embedding Table: 4ä¸ªèŠ‚ç‚¹åˆ†ç‰‡
<span class="k">-</span> Transformer Layers: 2ä¸ªèŠ‚ç‚¹pipeline
<span class="k">-</span> æ€»å»¶è¿Ÿ: max(shard_latencies) + communication

Data Parallel:

<span class="k">-</span> 8ä¸ªå‰¯æœ¬å¤„ç†ä¸åŒbatch
<span class="k">-</span> Load Balancer: ä¸€è‡´æ€§å“ˆå¸Œ
</code></pre></div>

<p><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¸‰çº§ç¼“å­˜</span><span class="o">:</span>
<span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="err">è¿›ç¨‹å†…</span><span class="n">LRU</span><span class="w"> </span><span class="o">(</span><span class="err">å‘½ä¸­ç‡</span><span class="o">~</span><span class="mi">30</span><span class="o">%)</span>
<span class="n">L2</span><span class="o">:</span><span class="w"> </span><span class="n">Redisé›†ç¾¤</span><span class="w"> </span><span class="o">(</span><span class="err">å‘½ä¸­ç‡</span><span class="o">~</span><span class="mi">50</span><span class="o">%)</span><span class="w">  </span>
<span class="n">L3</span><span class="o">:</span><span class="w"> </span><span class="n">CDNè¾¹ç¼˜èŠ‚ç‚¹</span><span class="w"> </span><span class="o">(</span><span class="err">å‘½ä¸­ç‡</span><span class="o">~</span><span class="mi">70</span><span class="o">%)</span>

<span class="err">ç¼“å­˜</span><span class="n">keyè®¾è®¡</span><span class="o">:</span>
<span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="o">(</span><span class="n">query_normalized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">time_bucket</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user_city</span><span class="o">)</span>
</code></pre></div>

<h3 id="_14">åœ¨çº¿å­¦ä¹ ä¸æ›´æ–°</h3>
<p><strong>å¢é‡ç´¢å¼•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">æ¯å°æ—¶æ›´æ–°</span><span class="o">:</span>

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="err">æ”¶é›†æ–°è§†é¢‘</span><span class="n">ID</span>
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="err">ç”Ÿæˆä¸´æ—¶</span><span class="n">Trieåˆ†æ”¯</span>
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="err">æ— é”åˆå¹¶åˆ°ä¸»</span><span class="n">Trie</span>
<span class="mi">4</span><span class="o">.</span><span class="w"> </span><span class="err">åŸå­åˆ‡æ¢æŒ‡é’ˆ</span>

<span class="err">çƒ­æ›´æ–°ä¸å½±å“æœåŠ¡ï¼Œå»¶è¿Ÿå¢åŠ </span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">ms</span>
</code></pre></div>

<p><strong>æŸ¥è¯¢è‡ªé€‚åº”</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">adaptive_decode</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
    <span class="c1"># æ ¹æ®å†å²ç»Ÿè®¡é€‰æ‹©ç­–ç•¥</span>
    <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">avg_results</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">aggressive_beam_search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stats</span><span class="o">.</span><span class="n">click_entropy</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">diverse_beam_search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">standard_decode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<h3 id="_15">æ€§èƒ½æŒ‡æ ‡</h3>
<p>éƒ¨ç½²åçš„å…³é”®æŒ‡æ ‡ï¼š</p>
<p>| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ä¼˜åŒ–å‰</th>
<th>ä¼˜åŒ–å</th>
<th>æå‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>P50å»¶è¿Ÿ</td>
<td>120ms</td>
<td>45ms</td>
<td>62.5%</td>
</tr>
<tr>
<td>P99å»¶è¿Ÿ</td>
<td>500ms</td>
<td>150ms</td>
<td>70%</td>
</tr>
<tr>
<td>QPSå®¹é‡</td>
<td>10K</td>
<td>50K</td>
<td>5Ã—</td>
</tr>
<tr>
<td>å¬å›ç‡@100</td>
<td>75%</td>
<td>82%</td>
<td>+7pp</td>
</tr>
<tr>
<td>ç¡¬ä»¶æˆæœ¬</td>
<td>100å°</td>
<td>40å°</td>
<td>60%å‡å°‘</td>
</tr>
</tbody>
</table>
<h3 id="_16">ç»éªŒæ•™è®­</h3>
<ol>
<li><strong>é¢„è®¡ç®—çš„é‡è¦æ€§</strong>ï¼šçƒ­é—¨æŸ¥è¯¢çš„ç»“æœé¢„è®¡ç®—ï¼Œè¦†ç›–30%æµé‡</li>
<li><strong>é™çº§ç­–ç•¥å¿…è¦æ€§</strong>ï¼šé«˜å³°æœŸè‡ªåŠ¨åˆ‡æ¢åˆ°æ›´å¿«ä½†ç•¥less accurateçš„æ¨¡å‹</li>
<li><strong>ç›‘æ§ç²’åº¦</strong>ï¼šä¸ä»…ç›‘æ§æ•´ä½“å»¶è¿Ÿï¼Œè¿˜è¦ç›‘æ§æ¯ä¸ªè§£ç æ­¥éª¤</li>
<li><strong>A/Bæµ‹è¯•æ¡†æ¶</strong>ï¼šæ”¯æŒå¤šç‰ˆæœ¬æ¨¡å‹å¹¶è¡Œservingï¼Œå®æ—¶æ¯”è¾ƒ</li>
<li><strong>ç¼“å­˜è®¾è®¡</strong>ï¼šå¤šçº§ç¼“å­˜æ˜¾è‘—é™ä½å¹³å‡å»¶è¿Ÿï¼Œä½†éœ€è¦è€ƒè™‘ä¸€è‡´æ€§</li>
<li><strong>æ‰¹å¤„ç†æƒè¡¡</strong>ï¼šåŠ¨æ€æ‰¹å¤„ç†æå‡ååé‡ä½†å¢åŠ å•ä¸ªè¯·æ±‚å»¶è¿Ÿ</li>
</ol>
<h2 id="_17">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†ç”Ÿæˆå¼æ£€ç´¢ä¸­çš„è§£ç ç­–ç•¥ä¸æ¨ç†ä¼˜åŒ–æŠ€æœ¯ã€‚æˆ‘ä»¬ä»çº¦æŸè§£ç çš„åŸºç¡€æ¦‚å¿µå‡ºå‘ï¼Œè¯¦ç»†åˆ†æäº†å¦‚ä½•é€šè¿‡Trieç­‰æ•°æ®ç»“æ„å®ç°é«˜æ•ˆçš„æ–‡æ¡£IDç”Ÿæˆçº¦æŸã€‚åœ¨Beam Searchéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸ä»…å›é¡¾äº†æ ‡å‡†ç®—æ³•ï¼Œè¿˜ä»‹ç»äº†é’ˆå¯¹æ£€ç´¢ä»»åŠ¡ä¼˜åŒ–çš„å¤šç§å˜ä½“ï¼ŒåŒ…æ‹¬å¤šæ ·æ€§å¢å¼ºã€é•¿åº¦å½’ä¸€åŒ–å’Œè‡ªé€‚åº”beam sizeç­‰æŠ€æœ¯ã€‚</p>
<p>å‰ç¼€æ ‘åŠ é€Ÿç« èŠ‚å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æ•°æ®ç»“æ„ä¼˜åŒ–ã€åŠ¨æ€å‰ªæå’Œç¡¬ä»¶åŠ é€Ÿæ¥æå‡æ¨ç†æ•ˆç‡ã€‚ç‰¹åˆ«æ˜¯SIMDå’ŒGPUå¹¶è¡ŒåŒ–æŠ€æœ¯ï¼Œèƒ½å¤Ÿå¸¦æ¥æ•°é‡çº§çš„æ€§èƒ½æå‡ã€‚åœ¨é«˜çº§è¯é¢˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ¢è®¨äº†éè‡ªå›å½’è§£ç è¿™ä¸€å‰æ²¿æ–¹å‘ï¼ŒåŒ…æ‹¬å¹¶è¡Œç”Ÿæˆã€è¿­ä»£ç²¾åŒ–å’Œæ··åˆæ¶æ„ç­‰åˆ›æ–°æ–¹æ³•ã€‚</p>
<p>é€šè¿‡å­—èŠ‚è·³åŠ¨æŠ–éŸ³æœç´¢çš„å·¥ä¸šæ¡ˆä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™äº›æŠ€æœ¯åœ¨å®é™…å¤§è§„æ¨¡ç³»ç»Ÿä¸­çš„åº”ç”¨ã€‚å…³é”®ä¼˜åŒ–åŒ…æ‹¬æ¨¡å‹å‹ç¼©ã€åŠ¨æ€æ‰¹å¤„ç†ã€åˆ†å¸ƒå¼éƒ¨ç½²å’Œå¤šçº§ç¼“å­˜ç­‰ï¼Œè¿™äº›æŠ€æœ¯çš„ç»¼åˆåº”ç”¨ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿåœ¨æ¯«ç§’çº§å»¶è¿Ÿå†…å¤„ç†äº¿çº§è§†é¢‘åº“çš„æ£€ç´¢è¯·æ±‚ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹æ€»ç»“</strong>ï¼š</p>
<ul>
<li>çº¦æŸè§£ç é€šè¿‡é™åˆ¶ç”Ÿæˆç©ºé—´ç¡®ä¿è¾“å‡ºæœ‰æ•ˆæ€§ï¼Œæ˜¯ç”Ÿæˆå¼æ£€ç´¢çš„åŸºç¡€</li>
<li>Beam Searchçš„å„ç§å˜ä½“åœ¨è´¨é‡-æ•ˆç‡æƒè¡¡ä¸­æä¾›äº†ä¸°å¯Œçš„é€‰æ‹©</li>
<li>æ•°æ®ç»“æ„å’Œç®—æ³•ä¼˜åŒ–ï¼ˆå¦‚Trieã€å‰ªæï¼‰å¯¹æ€§èƒ½è‡³å…³é‡è¦</li>
<li>éè‡ªå›å½’è§£ç é€šè¿‡å¹¶è¡ŒåŒ–çªç ´äº†ä¼ ç»Ÿçš„å»¶è¿Ÿç“¶é¢ˆ</li>
<li>æ··åˆæ¶æ„å¾€å¾€èƒ½åœ¨å®è·µä¸­å–å¾—æœ€ä½³çš„ç»¼åˆæ•ˆæœ</li>
<li>å·¥ä¸šéƒ¨ç½²éœ€è¦ç³»ç»Ÿæ€§çš„ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ¨¡å‹ã€ç®—æ³•å’Œå·¥ç¨‹å¤šä¸ªå±‚é¢</li>
</ul>
<h2 id="_18">ç»ƒä¹ é¢˜</h2>
<h3 id="_19">åŸºç¡€é¢˜</h3>
<p><strong>ä¹ é¢˜6.1</strong>ï¼šè§£é‡Šç¡¬çº¦æŸå’Œè½¯çº¦æŸåœ¨ç”Ÿæˆå¼æ£€ç´¢ä¸­çš„åŒºåˆ«ï¼Œå¹¶ç»™å‡ºå„è‡ªçš„é€‚ç”¨åœºæ™¯ã€‚</p>
<details markdown="1">
<summary>æç¤º</summary>
<p>è€ƒè™‘çº¦æŸçš„å¼ºåˆ¶æ€§ã€å®ç°å¤æ‚åº¦å’Œå¯¹ç”Ÿæˆè´¨é‡çš„å½±å“ã€‚
</details></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç¡¬çº¦æŸå®Œå…¨ç¦æ­¢æ— æ•ˆtokençš„ç”Ÿæˆï¼Œé€šè¿‡æ©ç å°†å…¶æ¦‚ç‡è®¾ä¸º0ï¼Œä¿è¯100%çš„æœ‰æ•ˆæ€§ä½†å¯èƒ½è¿‡äºä¸¥æ ¼ï¼›è½¯çº¦æŸé€šè¿‡è°ƒæ•´æ¦‚ç‡åˆ†å¸ƒå¼•å¯¼ç”Ÿæˆï¼Œå…è®¸ä¸€å®šçš„çµæ´»æ€§ã€‚ç¡¬çº¦æŸé€‚ç”¨äºæ–‡æ¡£IDå¿…é¡»ç²¾ç¡®åŒ¹é…çš„åœºæ™¯ï¼Œè½¯çº¦æŸé€‚ç”¨äºéœ€è¦æ¢ç´¢æ€§å’Œå®¹é”™æ€§çš„åœºæ™¯ï¼Œå¦‚æ¨¡ç³ŠåŒ¹é…æˆ–è¿‘ä¼¼æ£€ç´¢ã€‚</p>
</details>
<p><strong>ä¹ é¢˜6.2</strong>ï¼šç»™å®šä¸€ä¸ªåŒ…å«1000ä¸ªæ–‡æ¡£çš„é›†åˆï¼Œæ–‡æ¡£IDé‡‡ç”¨3å±‚å±‚æ¬¡åŒ–è®¾è®¡ï¼ˆ10ä¸ªç±»åˆ«ï¼Œæ¯ç±»10ä¸ªå­ç±»ï¼Œæ¯å­ç±»10ä¸ªæ–‡æ¡£ï¼‰ï¼Œè®¡ç®—ä½¿ç”¨å±‚æ¬¡åŒ–çº¦æŸç›¸æ¯”æ‰å¹³åŒ–æœç´¢çš„è®¡ç®—å¤æ‚åº¦é™ä½æ¯”ä¾‹ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>åˆ†åˆ«è®¡ç®—æ¯ç§æ–¹æ³•åœ¨æ¯ä¸ªè§£ç æ­¥éª¤éœ€è¦è€ƒè™‘çš„é€‰é¡¹æ•°é‡ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ‰å¹³åŒ–æœç´¢ï¼šæ¯æ­¥éœ€è¦ä»1000ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ã€‚
å±‚æ¬¡åŒ–æœç´¢ï¼šç¬¬1æ­¥10ä¸ªé€‰é¡¹ï¼ˆç±»åˆ«ï¼‰ï¼Œç¬¬2æ­¥10ä¸ªé€‰é¡¹ï¼ˆå­ç±»ï¼‰ï¼Œç¬¬3æ­¥10ä¸ªé€‰é¡¹ï¼ˆæ–‡æ¡£ï¼‰ã€‚
æ€»è®¡ç®—é‡æ¯”è¾ƒï¼šæ‰å¹³åŒ–éœ€è¦O(1000Ã—L)ï¼Œå±‚æ¬¡åŒ–éœ€è¦O(10+10+10)=O(30)ã€‚
å¤æ‚åº¦é™ä½æ¯”ä¾‹ï¼š1000L/30 â‰ˆ 33Lå€ï¼Œå…¶ä¸­Læ˜¯å¹³å‡åºåˆ—é•¿åº¦ã€‚</p>
</details>
<p><strong>ä¹ é¢˜6.3</strong>ï¼šå®ç°ä¸€ä¸ªç®€å•çš„Diverse Beam Searchç®—æ³•ï¼Œè¦æ±‚æ”¯æŒåŸºäºç¼–è¾‘è·ç¦»çš„å¤šæ ·æ€§æƒ©ç½šã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨åŠ¨æ€è§„åˆ’è®¡ç®—ç¼–è¾‘è·ç¦»ï¼Œåœ¨beamæ‰©å±•æ—¶åŠ å…¥å¤šæ ·æ€§æƒ©ç½šé¡¹ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ ¸å¿ƒæ€è·¯ï¼šå°†beamåˆ†ç»„ï¼Œæ¯ç»„ç‹¬ç«‹æœç´¢ï¼Œä½†åç»­ç»„åœ¨è¯„åˆ†æ—¶å‡å»ä¸å‰é¢ç»„çš„ç›¸ä¼¼åº¦æƒ©ç½šã€‚ç›¸ä¼¼åº¦ç”¨ç¼–è¾‘è·ç¦»çš„å€’æ•°è¡¡é‡ã€‚å…·ä½“å®ç°åŒ…æ‹¬ï¼š1ï¼‰ç»´æŠ¤å¤šä¸ªbeamç»„ï¼›2ï¼‰è®¡ç®—æ–°å€™é€‰ä¸å·²æœ‰ç»“æœçš„æœ€å°ç¼–è¾‘è·ç¦»ï¼›3ï¼‰æ ¹æ®è·ç¦»è°ƒæ•´å€™é€‰åˆ†æ•°ï¼›4ï¼‰æ¯ç»„é€‰æ‹©top-kå€™é€‰ã€‚</p>
</details>
<h3 id="_20">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ä¹ é¢˜6.4</strong>ï¼šè®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”çš„è§£ç ç­–ç•¥é€‰æ‹©å™¨ï¼Œèƒ½å¤Ÿæ ¹æ®æŸ¥è¯¢ç‰¹å¾ï¼ˆé•¿åº¦ã€å¤æ‚åº¦ã€å†å²ç‚¹å‡»ç‡ç­‰ï¼‰è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„è§£ç æ–¹æ³•ï¼ˆARã€NARæˆ–æ··åˆï¼‰ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ä½¿ç”¨æœºå™¨å­¦ä¹ æ–¹æ³•é¢„æµ‹æ¯ç§ç­–ç•¥çš„é¢„æœŸæ€§èƒ½ï¼Œå¹¶è¿›è¡Œå¤šç›®æ ‡ä¼˜åŒ–ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¾è®¡åŒ…æ‹¬ï¼š1ï¼‰ç‰¹å¾æå–ï¼šæŸ¥è¯¢é•¿åº¦ã€è¯é¢‘ç»Ÿè®¡ã€è¯­ä¹‰å¤æ‚åº¦ã€ç”¨æˆ·å†å²åå¥½ï¼›2ï¼‰æ€§èƒ½é¢„æµ‹æ¨¡å‹ï¼šä½¿ç”¨è½»é‡çº§åˆ†ç±»å™¨é¢„æµ‹æ¯ç§ç­–ç•¥çš„å»¶è¿Ÿå’Œå‡†ç¡®ç‡ï¼›3ï¼‰å†³ç­–é€»è¾‘ï¼šåŸºäºå»¶è¿Ÿé¢„ç®—å’Œè´¨é‡è¦æ±‚çš„å¸•ç´¯æ‰˜æœ€ä¼˜é€‰æ‹©ï¼›4ï¼‰åœ¨çº¿å­¦ä¹ ï¼šæ”¶é›†å®é™…æ€§èƒ½åé¦ˆï¼ŒæŒç»­ä¼˜åŒ–é¢„æµ‹æ¨¡å‹ã€‚å…³é”®æ˜¯å¹³è¡¡æ¢ç´¢ä¸åˆ©ç”¨ï¼Œå¯ä»¥ä½¿ç”¨contextual banditç®—æ³•ã€‚</p>
</details>
<p><strong>ä¹ é¢˜6.5</strong>ï¼šåˆ†æå¹¶æ¯”è¾ƒMask-Predictå’ŒCMLMä¸¤ç§è¿­ä»£ç²¾åŒ–ç­–ç•¥çš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶æå‡ºä¸€ç§ç»“åˆä¸¤è€…ä¼˜åŠ¿çš„æ–°æ–¹æ³•ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ç½®ä¿¡åº¦ä¼°è®¡çš„å‡†ç¡®æ€§ã€è¿­ä»£æ”¶æ•›é€Ÿåº¦å’Œè®¡ç®—æ•ˆç‡ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Mask-Predictä¼˜åŠ¿ï¼šç®€å•ç›´æ¥ï¼Œæ˜“äºå®ç°ï¼›ç¼ºç‚¹ï¼šå¯èƒ½é™·å…¥å±€éƒ¨æœ€ä¼˜ã€‚CMLMä¼˜åŠ¿ï¼šæ¢ç´¢ç©ºé—´æ›´å¤§ï¼Œè´¨é‡ä¸Šé™é«˜ï¼›ç¼ºç‚¹ï¼šæ”¶æ•›æ…¢ï¼Œè®¡ç®—å¼€é”€å¤§ã€‚
æ–°æ–¹æ³•ï¼šæ¸è¿›å¼æ··åˆç­–ç•¥ï¼ŒåˆæœŸä½¿ç”¨CMLMçš„é«˜maskç‡è¿›è¡Œå…¨å±€æ¢ç´¢ï¼ŒåæœŸåˆ‡æ¢åˆ°Mask-Predictçš„ä½maskç‡è¿›è¡Œå±€éƒ¨ç²¾åŒ–ã€‚å…³é”®åˆ›æ–°ï¼š1ï¼‰è‡ªé€‚åº”maskç‡è°ƒåº¦ï¼›2ï¼‰åŸºäºæ”¹è¿›é€Ÿåº¦çš„æ—©åœï¼›3ï¼‰å…³é”®ä½ç½®ä¿æŠ¤æœºåˆ¶ï¼Œé¿å…ç ´åå·²ç»é«˜ç½®ä¿¡åº¦çš„éƒ¨åˆ†ã€‚</p>
</details>
<p><strong>ä¹ é¢˜6.6</strong>ï¼šé’ˆå¯¹åŠ¨æ€æ›´æ–°çš„æ–‡æ¡£é›†åˆï¼ˆæ¯å¤©æ–°å¢/åˆ é™¤10%æ–‡æ¡£ï¼‰ï¼Œè®¾è®¡ä¸€ä¸ªå¢é‡å¼çš„Trieæ›´æ–°ç®—æ³•ï¼Œè¦æ±‚ä¸å½±å“åœ¨çº¿æœåŠ¡ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ç‰ˆæœ¬æ§åˆ¶ã€æ— é”æ•°æ®ç»“æ„å’Œæ¸è¿›å¼è¿ç§»ç­–ç•¥ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¾è®¡æ–¹æ¡ˆï¼š1ï¼‰åŒç¼“å†²Trieç»“æ„ï¼Œç»´æŠ¤å½“å‰ç‰ˆæœ¬å’Œä¸‹ä¸€ç‰ˆæœ¬ï¼›2ï¼‰å¢é‡æ„å»ºï¼šæ–°TrieåŸºäºæ—§Trieçš„å·®å¼‚æ›´æ–°ï¼Œä½¿ç”¨copy-on-writeä¼˜åŒ–å†…å­˜ï¼›3ï¼‰æ— é”åˆ‡æ¢ï¼šä½¿ç”¨åŸå­æŒ‡é’ˆæ“ä½œï¼Œè¯»è¯·æ±‚å§‹ç»ˆè®¿é—®ç¨³å®šç‰ˆæœ¬ï¼›4ï¼‰æ¸è¿›å¼GCï¼šå»¶è¿Ÿå›æ”¶æ—§ç‰ˆæœ¬ï¼Œç¡®ä¿æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢å®Œæˆï¼›5ï¼‰æ‰¹é‡æ›´æ–°ï¼šç´¯ç§¯å˜æ›´ï¼Œå®šæœŸæ‰¹é‡åº”ç”¨ï¼Œå‡å°‘åˆ‡æ¢å¼€é”€ã€‚å…³é”®ä¼˜åŒ–ï¼šçƒ­ç‚¹è·¯å¾„é¢„å¤åˆ¶ï¼Œå‡å°‘å†™æ—¶å¤åˆ¶çš„å»¶è¿Ÿå°–å³°ã€‚</p>
</details>
<p><strong>ä¹ é¢˜6.7</strong>ï¼šè®¾è®¡ä¸€ä¸ªæ€§èƒ½ç›‘æ§å’Œè‡ªåŠ¨è°ƒä¼˜ç³»ç»Ÿï¼Œèƒ½å¤Ÿå®æ—¶æ£€æµ‹ç”Ÿæˆå¼æ£€ç´¢ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆå¹¶è‡ªåŠ¨è°ƒæ•´å‚æ•°ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è€ƒè™‘å¤šç»´åº¦æŒ‡æ ‡ã€å¼‚å¸¸æ£€æµ‹å’Œåé¦ˆæ§åˆ¶ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç³»ç»Ÿè®¾è®¡ï¼š
1ï¼‰ç›‘æ§æŒ‡æ ‡ï¼šå»¶è¿Ÿåˆ†å¸ƒï¼ˆP50/P95/P99ï¼‰ã€ååé‡ã€ç¼“å­˜å‘½ä¸­ç‡ã€beamåˆ©ç”¨ç‡ã€GPUåˆ©ç”¨ç‡ï¼›
2ï¼‰å¼‚å¸¸æ£€æµ‹ï¼šä½¿ç”¨æ»‘åŠ¨çª—å£æ£€æµ‹æŒ‡æ ‡çªå˜ï¼ŒLSTMé¢„æµ‹æ­£å¸¸èŒƒå›´ï¼›
3ï¼‰ç“¶é¢ˆè¯Šæ–­ï¼šé€šè¿‡ç›¸å…³æ€§åˆ†æç¡®å®šä¸»è¦ç“¶é¢ˆï¼ˆè®¡ç®—ã€å†…å­˜ã€ç½‘ç»œï¼‰ï¼›
4ï¼‰è‡ªåŠ¨è°ƒä¼˜ï¼šæ ¹æ®ç“¶é¢ˆç±»å‹è§¦å‘ç›¸åº”ä¼˜åŒ–ï¼š</p>
<ul>
<li>é«˜å»¶è¿Ÿâ†’å‡å°beam size</li>
<li>ä½GPUåˆ©ç”¨ç‡â†’å¢åŠ batch size</li>
<li>å†…å­˜å‹åŠ›â†’å¯ç”¨é‡åŒ–</li>
<li>ç¼“å­˜å¤±æ•ˆâ†’è°ƒæ•´ç¼“å­˜ç­–ç•¥
5ï¼‰å®‰å…¨æœºåˆ¶ï¼šæ¸è¿›å¼è°ƒæ•´ï¼Œè®¾ç½®guardrailé˜²æ­¢å‰§çƒˆå˜åŒ–ï¼Œä¿ç•™å›æ»šèƒ½åŠ›ã€‚</li>
</ul>
</details>
<p><strong>ä¹ é¢˜6.8</strong>ï¼šå‡è®¾ä½ éœ€è¦å°†ç”Ÿæˆå¼æ£€ç´¢éƒ¨ç½²åˆ°è¾¹ç¼˜è®¾å¤‡ï¼ˆå¦‚æ‰‹æœºï¼‰ï¼Œå†…å­˜é™åˆ¶2GBï¼Œå»¶è¿Ÿè¦æ±‚&lt;100msï¼Œè®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘æ¨¡å‹å‹ç¼©ã€è®¡ç®—ä¼˜åŒ–å’Œèµ„æºè°ƒåº¦ç­‰å¤šä¸ªæ–¹é¢ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š
1ï¼‰æ¨¡å‹å‹ç¼©ï¼š</p>
<ul>
<li>8-bité‡åŒ–ï¼Œå‹ç¼©4Ã—</li>
<li>çŸ¥è¯†è’¸é¦åˆ°6å±‚å°æ¨¡å‹</li>
<li>
<p>æƒé‡å…±äº«å’Œå‰ªæï¼Œè¿›ä¸€æ­¥å‡å°‘50%å‚æ•°
2ï¼‰è®¡ç®—ä¼˜åŒ–ï¼š</p>
</li>
<li>
<p>ä½¿ç”¨ONNX Runtime Mobileæˆ–TensorFlow Lite</p>
</li>
<li>ç®—å­èåˆå‡å°‘å†…å­˜è®¿é—®</li>
<li>
<p>ç¼“å­˜ä¸­é—´æ¿€æ´»å€¼çš„é‡è®¡ç®—ç­–ç•¥
3ï¼‰ç´¢å¼•ä¼˜åŒ–ï¼š</p>
</li>
<li>
<p>åˆ†å±‚ç´¢å¼•ï¼ŒåªåŠ è½½çƒ­é—¨æ–‡æ¡£çš„å®Œæ•´ç´¢å¼•</p>
</li>
<li>å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿæ’é™¤</li>
<li>
<p>å‹ç¼©Trieç»“æ„ï¼Œä½¿ç”¨succinctæ•°æ®ç»“æ„
4ï¼‰åŠ¨æ€èµ„æºç®¡ç†ï¼š</p>
</li>
<li>
<p>æ ¹æ®ç”µé‡å’Œæ¸©åº¦åŠ¨æ€è°ƒæ•´è®¡ç®—å¼ºåº¦</p>
</li>
<li>åå°é¢„è®¡ç®—å’Œç¼“å­˜å¸¸è§æŸ¥è¯¢</li>
<li>
<p>ä¸äº‘ç«¯ååŒï¼Œå¤æ‚æŸ¥è¯¢å¸è½½åˆ°äº‘ç«¯
5ï¼‰ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼š</p>
</li>
<li>
<p>æ¸è¿›å¼ç»“æœè¿”å›</p>
</li>
<li>æœ¬åœ°ä¸ªæ€§åŒ–å¾®è°ƒ
é¢„æœŸæ•ˆæœï¼šæ¨¡å‹å¤§å°&lt;500MBï¼Œå¹³å‡å»¶è¿Ÿ&lt;80msï¼Œå‡†ç¡®ç‡ä¿æŒ90%ä»¥ä¸Šã€‚</li>
</ul>
</details>
<h2 id="_21">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<ol>
<li>
<p><strong>è¿‡åº¦çº¦æŸå¯¼è‡´å¬å›ä¸è¶³</strong>
   - é”™è¯¯ï¼šç¡¬çº¦æŸè®¾ç½®è¿‡ä¸¥ï¼Œåˆç†çš„å˜ä½“è¢«æ’é™¤
   - æ­£ç¡®ï¼šä½¿ç”¨è½¯çº¦æŸæˆ–è®¾ç½®åˆç†çš„çº¦æŸæ¾å¼›åº¦</p>
</li>
<li>
<p><strong>Beam sizeé€‰æ‹©ä¸å½“</strong>
   - é”™è¯¯ï¼šä¸€å‘³å¢åŠ beam sizeå¸Œæœ›æé«˜è´¨é‡
   - æ­£ç¡®ï¼šæ ¹æ®æ•°æ®åˆ†ææ‰¾åˆ°è´¨é‡-æ•ˆç‡çš„ç”œç‚¹ï¼Œé€šå¸¸5-10è¶³å¤Ÿ</p>
</li>
<li>
<p><strong>å¿½è§†ç¼“å­˜å±€éƒ¨æ€§</strong>
   - é”™è¯¯ï¼šTrieèŠ‚ç‚¹éšæœºåˆ†å¸ƒåœ¨å†…å­˜ä¸­
   - æ­£ç¡®ï¼šä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼Œçƒ­ç‚¹è·¯å¾„è¿ç»­å­˜å‚¨</p>
</li>
<li>
<p><strong>NARè®­ç»ƒä¸å……åˆ†</strong>
   - é”™è¯¯ï¼šç›´æ¥å°†ARæ¨¡å‹æ”¹ä¸ºNARï¼ŒæœŸæœ›ç›¸åŒæ€§èƒ½
   - æ­£ç¡®ï¼šNARéœ€è¦ç‰¹æ®Šçš„è®­ç»ƒç­–ç•¥ï¼Œå¦‚iterative refinement training</p>
</li>
<li>
<p><strong>æ‰¹å¤„ç†å¤§å°å›ºå®š</strong>
   - é”™è¯¯ï¼šä½¿ç”¨å›ºå®šçš„æ‰¹å¤„ç†å¤§å°ï¼Œå¯¼è‡´å»¶è¿Ÿæ³¢åŠ¨å¤§
   - æ­£ç¡®ï¼šåŠ¨æ€æ‰¹å¤„ç†ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œååé‡</p>
</li>
<li>
<p><strong>å¿½ç•¥æ–‡æ¡£æ›´æ–°çš„ä¸€è‡´æ€§</strong>
   - é”™è¯¯ï¼šå¢é‡æ›´æ–°æ—¶å‡ºç°çŸ­æš‚çš„ä¸ä¸€è‡´çŠ¶æ€
   - æ­£ç¡®ï¼šä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å’ŒåŸå­åˆ‡æ¢ä¿è¯ä¸€è‡´æ€§</p>
</li>
<li>
<p><strong>è¿‡åº¦ä¼˜åŒ–å±€éƒ¨æŒ‡æ ‡</strong>
   - é”™è¯¯ï¼šåªå…³æ³¨æ¨ç†å»¶è¿Ÿï¼Œå¿½è§†ç«¯åˆ°ç«¯ä½“éªŒ
   - æ­£ç¡®ï¼šç»¼åˆè€ƒè™‘å»¶è¿Ÿã€å‡†ç¡®ç‡ã€èµ„æºæ¶ˆè€—ç­‰å¤šä¸ªç»´åº¦</p>
</li>
<li>
<p><strong>æ··åˆæ¶æ„çš„å¤æ‚åº¦å¤±æ§</strong>
   - é”™è¯¯ï¼šç›²ç›®ç»„åˆå¤šç§æŠ€æœ¯ï¼Œç³»ç»Ÿå˜å¾—éš¾ä»¥ç»´æŠ¤
   - æ­£ç¡®ï¼šincrementalä¼˜åŒ–ï¼Œæ¯æ­¥éƒ½è¦éªŒè¯æ”¶ç›Š</p>
</li>
</ol>
<h2 id="_22">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_23">æ¨¡å‹è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] æ–‡æ¡£IDè®¾è®¡æ˜¯å¦ä¾¿äºçº¦æŸå’Œå¹¶è¡ŒåŒ–ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è¯„ä¼°äº†AR vs NAR vs æ··åˆæ¶æ„çš„æƒè¡¡ï¼Ÿ</li>
<li>[ ] æ¨¡å‹å¤§å°æ˜¯å¦é€‚åˆç›®æ ‡éƒ¨ç½²ç¯å¢ƒï¼Ÿ</li>
<li>[ ] æ˜¯å¦è®¾è®¡äº†åˆç†çš„fallbackæœºåˆ¶ï¼Ÿ</li>
</ul>
<h3 id="_24">ç®—æ³•ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] æ˜¯å¦å®ç°äº†é«˜æ•ˆçš„çº¦æŸè§£ç æœºåˆ¶ï¼Ÿ</li>
<li>[ ] Beam searchæ˜¯å¦åŒ…å«å¿…è¦çš„ä¼˜åŒ–ï¼ˆå¤šæ ·æ€§ã€é•¿åº¦å½’ä¸€åŒ–ç­‰ï¼‰ï¼Ÿ</li>
<li>[ ] æ˜¯å¦åˆ©ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼ˆSIMDã€GPUï¼‰ï¼Ÿ</li>
<li>[ ] å‰ªæç­–ç•¥æ˜¯å¦ç»è¿‡å……åˆ†è°ƒä¼˜ï¼Ÿ</li>
</ul>
<h3 id="_25">ç³»ç»Ÿå®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] æ•°æ®ç»“æ„é€‰æ‹©æ˜¯å¦è€ƒè™‘äº†ç¼“å­˜å‹å¥½æ€§ï¼Ÿ</li>
<li>[ ] æ˜¯å¦å®ç°äº†å¤šçº§ç¼“å­˜ç­–ç•¥ï¼Ÿ</li>
<li>[ ] æ‰¹å¤„ç†ç­–ç•¥æ˜¯å¦åŠ¨æ€å¯è°ƒï¼Ÿ</li>
<li>[ ] å†…å­˜ç®¡ç†æ˜¯å¦é¿å…äº†ç¢ç‰‡åŒ–ï¼Ÿ</li>
</ul>
<h3 id="_26">éƒ¨ç½²è¿ç»´é˜¶æ®µ</h3>
<ul>
<li>[ ] æ˜¯å¦æœ‰å®Œå–„çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æ”¯æŒåœ¨çº¿A/Bæµ‹è¯•ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æœ‰è‡ªåŠ¨é™çº§å’Œå®¹é”™æœºåˆ¶ï¼Ÿ</li>
<li>[ ] æ–‡æ¡£æ›´æ–°æ˜¯å¦æ”¯æŒçƒ­æ›´æ–°ï¼Ÿ</li>
</ul>
<h3 id="_27">æ€§èƒ½è°ƒä¼˜é˜¶æ®µ</h3>
<ul>
<li>[ ] æ˜¯å¦profilingäº†ä¸»è¦ç“¶é¢ˆï¼Ÿ</li>
<li>[ ] æ˜¯å¦å¹³è¡¡äº†å»¶è¿Ÿã€ååé‡å’Œèµ„æºæ¶ˆè€—ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é’ˆå¯¹ä¸åŒæŸ¥è¯¢ç±»å‹ä¼˜åŒ–ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è€ƒè™‘äº†å³°å€¼æµé‡çš„å¤„ç†ï¼Ÿ</li>
</ul>
<hr />
<p><em>ç»§ç»­å­¦ä¹ ï¼š<a href="chapter7.html">ç¬¬7ç« ï¼šNCIä¸å¯æ‰©å±•æ€§</a> â†’</em></p>
            </article>
            
            <nav class="page-nav"><a href="chapter5.html" class="nav-link prev">â† ç¬¬5ç« ï¼šç”Ÿæˆå¼æ£€ç´¢çš„è®­ç»ƒç­–ç•¥</a><a href="chapter7.html" class="nav-link next">ç¬¬7ç« ï¼šNCIä¸å¯æ‰©å±•æ€§ â†’</a></nav>
        </main>
    </div>
</body>
</html>